name: DVWA DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------
    # 1️⃣ Checkout Code
    # ---------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------
    # 2️⃣ Gitleaks – Secret Scanning
    # ---------------------------
    - name: Gitleaks Scan
      uses: gitleaks/gitleaks-action@v2
      with:
        fail: false

    # ---------------------------
    # 3️⃣ Semgrep – SAST
    # ---------------------------
    - name: Semgrep Scan
      uses: semgrep/semgrep-action@v1
      with:
        config: "p/default"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

    # ---------------------------
    # 4️⃣ Trivy – Filesystem Scan
    # ---------------------------
    - name: Trivy FS Scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        scan-type: fs
        severity: HIGH,CRITICAL
        exit-code: 0

    # ---------------------------
    # 5️⃣ Start DVWA Container
    # ---------------------------
    - name: Start DVWA
      run: |
        docker run -d \
          -p 8080:80 \
          --name dvwa \
          vulnerables/web-dvwa
        sleep 30

    # ---------------------------
    # 6️⃣ Trivy – Docker Image Scan
    # ---------------------------
    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: vulnerables/web-dvwa
        severity: HIGH,CRITICAL
        exit-code: 0

    # ---------------------------
    # 7️⃣ OWASP ZAP – DAST
    # ---------------------------
    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: "http://localhost:8080"
        fail_action: false
